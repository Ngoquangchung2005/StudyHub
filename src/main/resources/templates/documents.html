<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<head>
    <title>Kho t√†i li·ªáu</title>
    <style>
        /* CSS cho n√∫t Xem tr∆∞·ªõc */
        .btn-preview {
            border-radius: 20px;
            background-color: #f0f2f5;
            color: #333;
            border: 1px solid #ddd;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            padding: 5px 15px;
        }
        .btn-preview:hover {
            background-color: #e4e6eb;
            color: #000;
        }

        /* Modal preview full height */
        .preview-iframe {
            width: 100%;
            height: 75vh; /* Chi·ªÅu cao chi·∫øm 75% m√†n h√¨nh */
            border: none;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .preview-image {
            max-width: 100%;
            max-height: 75vh;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="search-bar-container">
        <form th:action="@{/documents}" method="GET" class="search-input-group">
            <span class="search-icon">üîç</span>
            <input type="text" name="keyword" class="search-input"
                   placeholder="T√¨m ki·∫øm t√†i li·ªáu, gi√°o tr√¨nh, b√†i t·∫≠p..."
                   th:value="${keyword}">
            <input type="hidden" name="categoryId" th:if="${currentCategoryId}" th:value="${currentCategoryId}">
            <button type="submit" class="search-btn">T√¨m ki·∫øm</button>
        </form>
    </div>

    <div class="category-filter">
        <h5>üìÇ Danh m·ª•c t√†i li·ªáu</h5>
        <div class="category-list">
            <a th:href="@{/documents(keyword=${keyword})}"
               class="category-badge"
               th:classappend="${currentCategoryId == null} ? 'active' : ''">
                <span>üåê</span> T·∫•t c·∫£
            </a>

            <a th:each="cat : ${categories}"
               th:href="@{/documents(categoryId=${cat.id}, keyword=${keyword})}"
               class="category-badge"
               th:classappend="${currentCategoryId == cat.id} ? 'active' : ''">
                <span th:text="${cat.icon}">üìÅ</span>
                <span th:text="${cat.name}">Category Name</span>
            </a>
        </div>
    </div>

    <div class="documents-grid" th:if="${documents != null && !documents.isEmpty()}">
        <div class="document-card" th:each="doc : ${documents}">

            <div class="document-thumbnail"
                 th:onclick="previewFile([[${doc.storagePath}]], [[${doc.fileName}]], [[${doc.title}]])"
                 style="cursor: pointer;">
                <div class="file-icon">
                    <span th:if="${doc.fileType != null && #strings.contains(doc.fileType, 'pdf')}">üìï</span>
                    <span th:if="${doc.fileType != null && (#strings.contains(doc.fileType, 'word') || #strings.contains(doc.fileType, 'officedocument'))}">üìù</span>
                    <span th:if="${doc.fileType != null && (#strings.contains(doc.fileType, 'sheet') || #strings.contains(doc.fileType, 'excel'))}">üìä</span>
                    <span th:if="${doc.fileType != null && #strings.contains(doc.fileType, 'presentation')}">üìΩÔ∏è</span>
                    <span th:if="${doc.fileType != null && #strings.contains(doc.fileType, 'image')}">üñºÔ∏è</span>
                    <span th:if="${doc.fileType == null || (!#strings.contains(doc.fileType, 'pdf') && !#strings.contains(doc.fileType, 'word') && !#strings.contains(doc.fileType, 'sheet') && !#strings.contains(doc.fileType, 'presentation') && !#strings.contains(doc.fileType, 'image'))}">üìÅ</span>
                </div>
                <div class="file-type-badge"
                     th:if="${doc.fileName != null}"
                     th:text="${#strings.substringAfter(doc.fileName, '.').toUpperCase()}">FILE</div>
            </div>

            <div class="document-info">
                <div class="document-title" th:text="${doc.title != null ? doc.title : doc.fileName}">Ti√™u ƒë·ªÅ t√†i li·ªáu</div>
                <div class="document-description" th:text="${doc.description}">M√¥ t·∫£ ng·∫Øn g·ªçn...</div>

                <div class="document-tags" th:if="${doc.tags != null && !doc.tags.isEmpty()}">
                    <span class="tag-badge" th:each="tag : ${#strings.arraySplit(doc.tags, ',')}" th:text="${'#' + tag.trim()}">#java</span>
                </div>

                <div class="document-meta pt-2 mt-2 d-flex align-items-center justify-content-between border-top">
                    <div class="document-author">
                        <div class="author-avatar">
                            <span th:text="${doc.user != null ? #strings.substring(doc.user.name, 0, 1) : '?'}">A</span>
                        </div>
                        <span th:text="${doc.user != null ? doc.user.name : 'Unknown'}">User</span>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn-preview border-0"
                                th:onclick="previewFile([[${doc.storagePath}]], [[${doc.fileName}]], [[${doc.title}]])"
                                title="Xem tr∆∞·ªõc">
                            üëÅÔ∏è Xem
                        </button>

                        <a th:href="@{/download/{fileName}(fileName=${doc.storagePath})}"
                           class="btn btn-sm btn-primary"
                           style="border-radius: 20px; display: inline-flex; align-items: center;"
                           onclick="event.stopPropagation();">
                            ‚¨á T·∫£i <span class="ms-1" th:text="${doc.downloads}">0</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="empty-state" th:if="${documents == null || documents.isEmpty()}">
        <div class="empty-icon">üì≠</div>
        <h4>Kh√¥ng t√¨m th·∫•y t√†i li·ªáu n√†o</h4>
        <p>Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c ch·ªçn danh m·ª•c kh√°c.</p>
        <a th:href="@{/upload}" class="btn btn-primary mt-3">ƒêƒÉng t·∫£i t√†i li·ªáu ngay</a>
    </div>

    <a th:href="@{/upload}" class="upload-btn-float" title="ƒêƒÉng t·∫£i t√†i li·ªáu m·ªõi">
        +
    </a>

    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered"> <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
            <div class="modal-header border-0 bg-light py-2">
                <h5 class="modal-title fw-bold text-primary" id="previewTitle">üìÑ Xem t√†i li·ªáu</h5>
                <div class="ms-auto d-flex gap-2">
                    <a href="#" id="previewDownloadBtn" class="btn btn-primary btn-sm rounded-pill">‚¨á T·∫£i xu·ªëng</a>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0 bg-light text-center d-flex align-items-center justify-content-center" style="min-height: 400px;">
                <div id="previewContent" class="w-100 h-100">
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        function previewFile(storagePath, fileName, title) {
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const contentDiv = document.getElementById('previewContent');
            const titleEl = document.getElementById('previewTitle');
            const downloadBtn = document.getElementById('previewDownloadBtn');

            // Set th√¥ng tin c∆° b·∫£n
            titleEl.textContent = title || fileName;
            downloadBtn.href = '/download/' + storagePath;

            // X√°c ƒë·ªãnh lo·∫°i file qua ƒëu√¥i m·ªü r·ªông
            const ext = fileName.split('.').pop().toLowerCase();
            const fileUrl = '/view-file/' + storagePath;

            let html = '';

            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) {
                // X·ª≠ l√Ω ·∫¢nh
                html = `<img src="${fileUrl}" class="preview-image" alt="Preview">`;

            } else if (ext === 'pdf') {
                // X·ª≠ l√Ω PDF (Tr√¨nh duy·ªát h·ªó tr·ª£ t·ªët)
                html = `<iframe src="${fileUrl}" class="preview-iframe"></iframe>`;

            } else if (ext === 'txt') {
                // X·ª≠ l√Ω file text
                html = `<iframe src="${fileUrl}" class="preview-iframe" style="background: white;"></iframe>`;

            } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
                // X·ª≠ l√Ω Video
                html = `<video controls class="preview-image" style="background:black;"><source src="${fileUrl}" type="video/${ext}">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video n√†y.</video>`;

            } else {
                // C√°c file kh√¥ng h·ªó tr·ª£ xem tr·ª±c ti·∫øp (Word, Excel, PPT...)
                html = `
                    <div class="text-center p-5">
                        <div style="font-size: 60px; margin-bottom: 20px;">üìù</div>
                        <h4>Kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc ƒë·ªãnh d·∫°ng n√†y</h4>
                        <p class="text-muted">ƒê√¢y l√† file <b>.${ext.toUpperCase()}</b>. Vui l√≤ng t·∫£i xu·ªëng ƒë·ªÉ xem n·ªôi dung.</p>
                        <a href="/download/${storagePath}" class="btn btn-lg btn-primary mt-2 rounded-pill">
                            ‚¨á T·∫£i xu·ªëng m√°y
                        </a>
                    </div>
                `;
            }

            contentDiv.innerHTML = html;
            modal.show();
        }
    </script>

</div>

</body>
</html>