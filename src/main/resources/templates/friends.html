<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<head>
    <title>L·ªùi m·ªùi k·∫øt b·∫°n</title>
</head>
<body>
<div layout:fragment="content" class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                <div class="card-header bg-white border-0 pt-4 pb-2">
                    <h4 class="fw-bold">üîî L·ªùi m·ªùi k·∫øt b·∫°n</h4>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(requests)}" class="text-center py-5 text-muted">
                        <span style="font-size: 50px;">üì≠</span>
                        <p class="mt-3">Hi·ªán kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n n√†o.</p>
                    </div>

                    <div th:each="req : ${requests}" class="d-flex align-items-center justify-content-between p-3 mb-2 border rounded-3 friend-request-item">
                        <div class="d-flex align-items-center">
                            <img th:if="${req.requester.avatarUrl}"
                                 th:src="@{'/view-file/' + ${req.requester.avatarUrl}}"
                                 class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                            <div th:unless="${req.requester.avatarUrl}"
                                 class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                 style="width: 50px; height: 50px; font-weight: bold;"
                                 th:text="${#strings.substring(req.requester.name, 0, 1)}"></div>

                            <div class="ms-3">
                                <h6 class="mb-0 fw-bold" th:text="${req.requester.name}">User Name</h6>
                                <small class="text-muted" th:text="'@' + ${req.requester.username}">@username</small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm btn-accept" th:data-id="${req.id}">Ch·∫•p nh·∫≠n</button>
                            <button class="btn btn-light btn-sm text-danger">X√≥a</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mt-4" style="border-radius: 15px;">
                <div class="card-header bg-white border-0 pt-4 pb-2">
                    <h5 class="fw-bold">üë• B·∫°n b√® (<span th:text="${friends != null ? friends.size() : 0}">0</span>)</h5>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(friends)}" class="text-center py-3 text-muted">
                        B·∫°n ch∆∞a c√≥ b·∫°n b√® n√†o. H√£y t√¨m ki·∫øm v√† k·∫øt b·∫°n nh√©!
                    </div>

                    <div th:each="friend : ${friends}" class="border-bottom p-2 d-flex align-items-center justify-content-between friend-item-row">
                        <a th:href="@{'/profile/' + ${friend.username}}" class="d-flex align-items-center text-decoration-none text-dark flex-grow-1">

                            <img th:if="${friend.avatarUrl}"
                                 th:src="@{'/view-file/' + ${friend.avatarUrl}}"
                                 class="rounded-circle" style="width: 45px; height: 45px; object-fit: cover;">
                            <div th:unless="${friend.avatarUrl}"
                                 class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center"
                                 style="width: 45px; height: 45px; font-weight: bold;"
                                 th:text="${#strings.substring(friend.name, 0, 1)}"></div>

                            <div class="ms-3">
                                <h6 class="mb-0 fw-bold" th:text="${friend.name}">Friend Name</h6>
                                <small class="text-muted" th:text="'@' + ${friend.username}">@username</small>
                            </div>
                        </a>

                        <div>
                            <a th:href="@{'/profile/' + ${friend.username}}" class="btn btn-outline-secondary btn-sm rounded-pill me-1">
                                <i class="bi bi-person"></i>
                            </a>
                            <button class="btn btn-outline-danger btn-sm rounded-pill btn-unfriend" th:data-id="${friend.id}" title="H·ªßy k·∫øt b·∫°n">
                                <i class="bi bi-person-x-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mt-4" style="border-radius: 15px;">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">T√¨m ki·∫øm b·∫°n m·ªõi</h5>
                    <div class="input-group">
                        <input type="text" id="search-friend-input" class="form-control" placeholder="Nh·∫≠p t√™n ho·∫∑c email...">
                        <button class="btn btn-outline-primary" id="btn-search-users">T√¨m</button>
                    </div>
                    <div id="search-results" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        // --- 1. X·ª≠ l√Ω Ch·∫•p nh·∫≠n k·∫øt b·∫°n ---
        document.querySelectorAll('.btn-accept').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.getAttribute('data-id');
                try {
                    const res = await fetch(`/api/friends/accept/${id}`, {
                        method: 'POST',
                        headers: { [csrfHeader]: csrfToken }
                    });
                    if(res.ok) {
                        alert("ƒê√£ k·∫øt b·∫°n th√†nh c√¥ng!");
                        location.reload();
                    }
                } catch(e) { console.error(e); }
            });
        });

        // --- 2. X·ª≠ l√Ω H·ªßy k·∫øt b·∫°n (M·ªöI TH√äM) ---
        document.querySelectorAll('.btn-unfriend').forEach(btn => {
            btn.addEventListener('click', async function() {
                const friendId = this.getAttribute('data-id');

                if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy k·∫øt b·∫°n v·ªõi ng∆∞·ªùi n√†y?")) {
                    return;
                }

                try {
                    const res = await fetch(`/api/friends/unfriend/${friendId}`, {
                        method: 'POST',
                        headers: { [csrfHeader]: csrfToken }
                    });

                    if(res.ok) {
                        // X√≥a d√≤ng n√†y kh·ªèi giao di·ªán ngay l·∫≠p t·ª©c
                        this.closest('.friend-item-row').remove();
                        // Ho·∫∑c reload n·∫øu mu·ªën c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ch√≠nh x√°c
                        // location.reload();
                    } else {
                        alert("C√≥ l·ªói x·∫£y ra khi h·ªßy k·∫øt b·∫°n.");
                    }
                } catch(e) {
                    console.error(e);
                    alert("L·ªói k·∫øt n·ªëi.");
                }
            });
        });

        // --- 3. X·ª≠ l√Ω T√¨m ki·∫øm v√† K·∫øt b·∫°n ---
        document.getElementById('btn-search-users').addEventListener('click', async function() {
            const keyword = document.getElementById('search-friend-input').value.trim();
            if (!keyword) return;

            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';

            try {
                const res = await fetch(`/api/friends/search?keyword=${encodeURIComponent(keyword)}`);
                if (res.ok) {
                    const users = await res.json();
                    resultsDiv.innerHTML = '';

                    if (users.length === 0) {
                        resultsDiv.innerHTML = '<p class="text-muted text-center">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o.</p>';
                        return;
                    }

                    users.forEach(user => {
                        let avatarHtml = '';
                        if (user.avatarUrl) {
                            avatarHtml = `<img src="/view-file/${user.avatarUrl}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">`;
                        } else {
                            const initial = user.name ? user.name.charAt(0) : 'U';
                            avatarHtml = `<div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-weight: bold;">${initial}</div>`;
                        }

                        let actionBtn = '';
                        if (user.status === 'FRIEND') {
                            actionBtn = `<span class="badge bg-success">ƒê√£ l√† b·∫°n</span>`;
                        } else if (user.status === 'SENT') {
                            actionBtn = `<button class="btn btn-secondary btn-sm" disabled>ƒê√£ g·ª≠i</button>`;
                        } else if (user.status === 'RECEIVED') {
                            actionBtn = `<span class="badge bg-warning text-dark">ƒêang ch·ªù duy·ªát</span>`;
                        } else {
                            actionBtn = `<button class="btn btn-outline-primary btn-sm btn-add-friend" data-id="${user.id}">K·∫øt b·∫°n</button>`;
                        }

                        const item = document.createElement('div');
                        item.className = 'd-flex align-items-center justify-content-between p-2 border-bottom';
                        item.innerHTML = `
                            <div class="d-flex align-items-center">
                                ${avatarHtml}
                                <div class="ms-3">
                                    <h6 class="mb-0 fw-bold">${user.name}</h6>
                                    <small class="text-muted">@${user.username}</small>
                                </div>
                            </div>
                            <div>${actionBtn}</div>
                        `;
                        resultsDiv.appendChild(item);
                    });
                    attachAddFriendEvents();
                }
            } catch (e) {
                console.error(e);
                resultsDiv.innerHTML = '<p class="text-danger text-center">C√≥ l·ªói x·∫£y ra.</p>';
            }
        });

        function attachAddFriendEvents() {
            document.querySelectorAll('.btn-add-friend').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const userId = this.getAttribute('data-id');
                    this.disabled = true;
                    this.textContent = 'ƒêang g·ª≠i...';

                    try {
                        const res = await fetch(`/api/friends/request/${userId}`, {
                            method: 'POST',
                            headers: { [csrfHeader]: csrfToken }
                        });

                        if (res.ok) {
                            this.className = 'btn btn-secondary btn-sm';
                            this.textContent = 'ƒê√£ g·ª≠i l·ªùi m·ªùi';
                        } else {
                            this.disabled = false;
                            this.textContent = 'L·ªói';
                        }
                    } catch (e) {
                        this.disabled = false;
                        this.textContent = 'L·ªói';
                    }
                });
            });
        }
    </script>
</div>
</body>
</html>