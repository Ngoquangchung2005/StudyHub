<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<head>
    <title>B·∫°n b√®</title>
    <style>
        .friend-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .friend-card:hover { transform: translateY(-3px); }
        .friend-avatar {
            width: 80px; height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .nav-pills .nav-link.active {
            background-color: #6f42c1;
        }
        .nav-pills .nav-link {
            color: #495057;
            border-radius: 20px;
            padding: 8px 20px;
        }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body p-4">
                    <h4 class="fw-bold mb-4 text-primary">üë• Qu·∫£n l√Ω b·∫°n b√®</h4>

                    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold" id="pills-list-tab" data-bs-toggle="pill" data-bs-target="#pills-list" type="button">Danh s√°ch b·∫°n b√®</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold" id="pills-requests-tab" data-bs-toggle="pill" data-bs-target="#pills-requests" type="button">L·ªùi m·ªùi k·∫øt b·∫°n <span class="badge bg-danger rounded-pill" th:if="${pendingRequests.size() > 0}" th:text="${pendingRequests.size()}"></span></button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold" id="pills-search-tab" data-bs-toggle="pill" data-bs-target="#pills-search" type="button">üîç T√¨m b·∫°n m·ªõi</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="pills-tabContent">

                        <div class="tab-pane fade show active" id="pills-list">
                            <div th:if="${friends.isEmpty()}" class="text-center py-5 text-muted">
                                <p>B·∫°n ch∆∞a c√≥ ng∆∞·ªùi b·∫°n n√†o.</p>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6" th:each="friend : ${friends}">
                                    <div class="card friend-card p-3">
                                        <div class="d-flex align-items-center">
                                            <a th:href="@{/profile/{u}(u=${friend.username})}">
                                                <img th:if="${friend.avatarUrl}" th:src="@{/view-file/{f}(f=${friend.avatarUrl})}" class="friend-avatar bg-light">
                                                <div th:unless="${friend.avatarUrl}" class="friend-avatar bg-light d-flex align-items-center justify-content-center fw-bold fs-4 text-primary">
                                                    <span th:text="${#strings.substring(friend.name,0,1)}"></span>
                                                </div>
                                            </a>
                                            <div class="ms-3 flex-grow-1">
                                                <h6 class="mb-1 fw-bold"><a th:href="@{/profile/{u}(u=${friend.username})}" class="text-decoration-none text-dark" th:text="${friend.name}">Name</a></h6>
                                                <div class="d-flex gap-2 mt-2">
                                                    <a th:href="@{/chat(withUser=${friend.id})}" class="btn btn-sm btn-primary rounded-pill px-3">Chat</a>
                                                    <form th:action="@{/friends/unfriend/{id}(id=${friend.id})}" method="post" onsubmit="return confirm('H·ªßy k·∫øt b·∫°n?');">
                                                        <button class="btn btn-sm btn-outline-danger rounded-pill px-3">H·ªßy KB</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="pills-requests">
                            <div th:if="${pendingRequests.isEmpty()}" class="text-center py-5 text-muted">
                                <p>Kh√¥ng c√≥ l·ªùi m·ªùi n√†o.</p>
                            </div>
                            <div class="list-group">
                                <div th:each="req : ${pendingRequests}" class="list-group-item d-flex align-items-center justify-content-between p-3 border rounded mb-2">
                                    <div class="d-flex align-items-center">
                                        <img th:if="${req.requester.avatarUrl}" th:src="@{/view-file/{f}(f=${req.requester.avatarUrl})}" class="rounded-circle me-3" width="50" height="50">
                                        <div th:unless="${req.requester.avatarUrl}" class="rounded-circle me-3 bg-light d-flex align-items-center justify-content-center fw-bold" style="width:50px; height:50px;">
                                            <span th:text="${#strings.substring(req.requester.name,0,1)}"></span>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 fw-bold"><a th:href="@{/profile/{u}(u=${req.requester.username})}" class="text-decoration-none text-dark" th:text="${req.requester.name}">Name</a></h6>
                                            <small class="text-muted">Mu·ªën k·∫øt b·∫°n v·ªõi b·∫°n</small>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <form th:action="@{/friends/accept/{id}(id=${req.id})}" method="post">
                                            <button class="btn btn-success btn-sm rounded-pill fw-bold">Ch·∫•p nh·∫≠n</button>
                                        </form>
                                        <form th:action="@{/friends/decline/{id}(id=${req.id})}" method="post">
                                            <button class="btn btn-outline-secondary btn-sm rounded-pill">X√≥a</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="pills-search">
                            <div class="input-group mb-4">
                                <input type="text" id="search-friend-input" class="form-control" placeholder="Nh·∫≠p t√™n, email ho·∫∑c username..." style="border-radius: 20px 0 0 20px;">
                                <button class="btn btn-primary px-4" id="btn-search-users" style="border-radius: 0 20px 20px 0;">T√¨m ki·∫øm</button>
                            </div>

                            <div id="search-results-area" class="row g-3">
                                <div class="text-center text-muted py-4">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m b·∫°n m·ªõi.</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts">
    // Logic t√¨m ki·∫øm b·∫°n b√®
    const searchInput = document.getElementById('search-friend-input');
    const searchBtn = document.getElementById('btn-search-users');
    const resultsArea = document.getElementById('search-results-area');

    if(searchBtn) {
        searchBtn.addEventListener('click', function() {
            const keyword = searchInput.value;
            if(!keyword.trim()) return;

            // Hi·ªÉn th·ªã loading
            resultsArea.innerHTML = '<div class="text-center w-100 py-3"><div class="spinner-border text-primary" role="status"></div></div>';

            // G·ªçi API Search
            fetch(`/api/friends/search?q=${encodeURIComponent(keyword)}`)
                .then(response => response.json())
                .then(users => {
                    resultsArea.innerHTML = '';
                    if(users.length === 0) {
                        resultsArea.innerHTML = '<div class="text-center w-100 text-muted">Kh√¥ng t√¨m th·∫•y ai.</div>';
                        return;
                    }

                    users.forEach(user => {
                        const avatarHtml = user.avatarUrl
                            ? `<img src="/view-file/${user.avatarUrl}" class="rounded-circle bg-light" width="60" height="60" style="object-fit:cover;">`
                            : `<div class="rounded-circle bg-light d-flex align-items-center justify-content-center fw-bold" style="width:60px; height:60px; font-size:20px;">${user.name.charAt(0)}</div>`;

                        const html = `
                            <div class="col-md-6">
                                <div class="card p-3 border shadow-sm h-100">
                                    <div class="d-flex align-items-center">
                                        <a href="/profile/${user.username}">${avatarHtml}</a>
                                        <div class="ms-3 flex-grow-1">
                                            <h6 class="mb-1 fw-bold"><a href="/profile/${user.username}" class="text-decoration-none text-dark">${user.name}</a></h6>
                                            <div class="text-muted small mb-2">@${user.username}</div>
                                            <button class="btn btn-sm btn-outline-primary rounded-pill btn-add-friend-search" data-id="${user.id}">‚ûï K·∫øt b·∫°n</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        resultsArea.insertAdjacentHTML('beforeend', html);
                    });

                    // G·∫Øn s·ª± ki·ªán cho n√∫t k·∫øt b·∫°n
                    document.querySelectorAll('.btn-add-friend-search').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            sendRequest(userId, this);
                        });
                    });
                })
                .catch(err => {
                    console.error(err);
                    resultsArea.innerHTML = '<div class="text-center w-100 text-danger">L·ªói t√¨m ki·∫øm.</div>';
                });
        });
    }

    // H√†m g·ª≠i k·∫øt b·∫°n (AJAX)
    function sendRequest(userId, btnElement) {
        const originalText = btnElement.innerHTML;
        btnElement.disabled = true;
        btnElement.innerHTML = '...';

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/api/friends/request/${userId}`, {
            method: 'POST',
            headers: { [csrfHeader]: csrfToken }
        })
            .then(res => {
                if(res.ok) {
                    btnElement.className = 'btn btn-sm btn-secondary rounded-pill';
                    btnElement.innerHTML = 'üì© ƒê√£ g·ª≠i';
                } else {
                    return res.text().then(text => { throw new Error(text) });
                }
            })
            .catch(err => {
                alert("Kh√¥ng th·ªÉ g·ª≠i l·ªùi m·ªùi: " + err.message); // Th∆∞·ªùng l·ªói do ƒë√£ k·∫øt b·∫°n r·ªìi
                btnElement.disabled = false;
                btnElement.innerHTML = originalText;
            });
    }
</script>

</body>
</html>