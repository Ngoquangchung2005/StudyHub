<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout.html}">
<head>
    <title th:text="${profileUser.name}">Trang c√° nh√¢n</title>
</head>
<body>

<div layout:fragment="content">

    <div class="profile-header-container">
        <div class="profile-cover-photo"
             th:style="${profileUser.coverPhotoUrl != null and !#strings.isEmpty(profileUser.coverPhotoUrl)}
     ? 'background-image: url(\'' + @{/view-file/{fileName}(fileName=${profileUser.coverPhotoUrl})} + '\'); background-size: cover; background-position: center;'
     : 'background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);'">
        </div>

        <div class="profile-info-bar">
            <div class="profile-avatar-container">
                <img th:if="${profileUser.avatarUrl != null}"
                     th:src="@{/view-file/{fileName}(fileName=${profileUser.avatarUrl})}"
                     alt="Avatar">
                <div th:if="${profileUser.avatarUrl == null}"
                     class="profile-avatar-container-default">
                    <span th:text="${#strings.substring(profileUser.name, 0, 1)}">U</span>
                </div>
            </div>
            <div class="profile-name-bio">
                <h2 class="mt-3 mb-1" th:text="${profileUser.name}">T√™n User</h2>
                <p th:if="${profileUser.bio != null && !profileUser.bio.isEmpty()}"
                   th:text="${profileUser.bio}">
                    Ti·ªÉu s·ª≠ c·ªßa user.
                </p>
            </div>
            <div class="profile-buttons"
                 sec:authorize="isAuthenticated()"
                 th:if="${currentUser != null && currentUser.id == profileUser.id}">
                <a th:href="@{/profile/edit}" class="btn btn-primary">
                    ‚öôÔ∏è Ch·ªânh s·ª≠a trang c√° nh√¢n
                </a>
            </div>
            <div class="profile-buttons"
                 sec:authorize="isAuthenticated()"
                 th:if="${currentUser != null && currentUser.id != profileUser.id}">
                <a th:href="@{/chat(withUser=${profileUser.id})}" class="btn btn-outline-primary">
                    üí¨ Nh·∫Øn tin
                </a>
            </div>
        </div>

        <nav class="profile-nav">
            <div class="nav nav-tabs" id="profile-tab">
                <button class="nav-link active" id="posts-tab" data-bs-toggle="tab"
                        data-bs-target="#posts-content" type="button">
                    B√†i vi·∫øt
                </button>
                <button class="nav-link" id="about-tab" data-bs-toggle="tab"
                        data-bs-target="#about-content" type="button">
                    Gi·ªõi thi·ªáu
                </button>
            </div>
        </nav>
    </div>

    <div class="row justify-content-center">

        <div class="col-lg-4 d-none d-lg-block">
            <div class="card profile-info-box">
                <div class="card-body">
                    <h5>Gi·ªõi thi·ªáu</h5>

                    <div class="info-item" th:if="${profileUser.userType != null}">
                        <span class="info-icon">üéì</span>
                        <p>
                            L√† <strong th:text="${profileUser.userType.displayName}">Sinh vi√™n</strong>
                            <span th:if="${profileUser.school != null}">
                t·∫°i <strong><span th:text="${profileUser.school}"></span></strong>
              </span>
                        </p>
                    </div>

                    <div class="info-item" th:if="${profileUser.major != null}">
                        <span class="info-icon">üíª</span>
                        <p>H·ªçc <strong th:text="${profileUser.major}">Chuy√™n ng√†nh</strong></p>
                    </div>

                    <div class="info-item" th:if="${profileUser.location != null}">
                        <span class="info-icon">üìç</span>
                        <p>S·ªëng ·ªü <strong><span th:text="${profileUser.location}"></span></strong></p>
                    </div>

                    <div class="info-item" th:if="${profileUser.hometown != null}">
                        <span class="info-icon">üè†</span>
                        <p>ƒê·∫øn t·ª´ <strong><span th:text="${profileUser.hometown}"></span></strong></p>
                    </div>

                    <div class="info-item" th:if="${profileUser.birthday != null}">
                        <span class="info-icon">üéÇ</span>
                        <p>
                            Sinh ng√†y <strong th:text="${#temporals.format(profileUser.birthday, 'dd/MM/yyyy')}"></strong>
                        </p>
                    </div>

                    <hr>

                    <h5>Th√¥ng tin li√™n h·ªá</h5>
                    <div class="info-item" th:if="${profileUser.email != null}">
                        <span class="info-icon">‚úâÔ∏è</span>
                        <p>Email: <strong th:text="${profileUser.email}"></strong></p>
                    </div>
                    <div class="info-item" th:if="${profileUser.contactPhone != null}">
                        <span class="info-icon">üìû</span>
                        <p>SƒêT: <strong th:text="${profileUser.contactPhone}"></strong></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-md-10">

            <h2 class="h4 mb-3" style="color: white; opacity: 0.9;">B√†i ƒëƒÉng</h2>

            <div th:if="${posts == null || posts.isEmpty()}" class="alert alert-info">
                Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o.
            </div>

            <div class="card mb-3" th:each="post : ${posts}">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <div class="post-author-avatar">
                                <img th:if="${post.user.avatarUrl != null}"
                                     th:src="@{/view-file/{fileName}(fileName=${post.user.avatarUrl})}"
                                     alt="Avatar">
                                <span th:if="${post.user.avatarUrl == null}"
                                      th:text="${#strings.substring(post.user.name, 0, 1)}">
                                </span>
                            </div>
                            <div class="ms-2">
                                <div class="fw-bold">
                                    <a th:href="@{/profile/{username}(username=${post.user.username})}"
                                       th:text="${post.user.name}"
                                       style="text-decoration: none; color: inherit;">
                                        T√™n T√°c Gi·∫£
                                    </a>
                                </div>
                                <div class="text-muted small">
                                    <span th:text="${#temporals.format(post.createdAt, 'HH:mm ''ng√†y'' dd/MM/yyyy')}">
                                        Ng√†y ƒëƒÉng
                                    </span>
                                    <span th:if="${post.isPublic}" title="C√¥ng khai">üåê</span>
                                    <span th:if="${!post.isPublic}" title="Ri√™ng t∆∞">üîí</span>
                                </div>
                            </div>
                        </div>

                        <div class="dropdown" th:if="${currentUserId == post.user.id}">
                            <button class="btn btn-link text-dark p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="text-decoration: none; font-size: 20px;">
                                ‚ãÆ
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                                <li>
                                    <a class="dropdown-item py-2" th:href="@{/posts/edit/{id}(id=${post.id})}">
                                        ‚úèÔ∏è Ch·ªânh s·ª≠a b√†i vi·∫øt
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="POST"
                                          onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.');">
                                        <button type="submit" class="dropdown-item py-2 text-danger">
                                            üóëÔ∏è X√≥a b√†i vi·∫øt
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <p class="card-text" th:if="${post.content != null && !post.content.isEmpty()}" th:text="${post.content}">N·ªôi dung b√†i ƒëƒÉng...</p>

                    <div th:if="${post.documents != null && !post.documents.isEmpty()}" class="mt-3">
                        <div class="list-group">
                            <div th:each="doc : ${post.documents}"
                                 class="list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded p-3">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h5 class="mb-1 fw-bold" style="font-size: 1.1rem;">
                                        üìÑ <span th:text="${doc.title != null && !doc.title.isEmpty() ? doc.title : doc.fileName}">Ti√™u ƒë·ªÅ</span>
                                    </h5>
                                    <a th:href="@{/download/{fileName}(fileName=${doc.storagePath})}"
                                       class="btn btn-sm btn-primary ms-3 flex-shrink-0">
                                        T·∫£i xu·ªëng
                                    </a>
                                </div>
                                <p class="mb-1" th:if="${doc.description != null && !doc.description.isEmpty() && doc.description != post.content}" th:text="${doc.description}">M√¥ t·∫£...</p>
                                <small class="text-muted d-block mt-2">
                                    <span th:if="${doc.category != null}" class="badge bg-secondary me-2" th:text="${doc.category.name}">Category</span>
                                    <span th:text="${doc.fileName} + ' (' + (${doc.fileSize < 1024*1024 ? #numbers.formatDecimal(doc.fileSize / 1024.0, 1, 'COMMA', 1, 'POINT') + ' KB' : #numbers.formatDecimal(doc.fileSize / 1024.0 / 1024.0, 1, 'COMMA', 1, 'POINT') + ' MB'}) + ')'">size</span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex gap-3">
                        <form th:action="@{/posts/{postId}/like(postId=${post.id})}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-link text-decoration-none p-0"
                                    th:with="liked = ${#lists.contains(post.reactions.![user.id], currentUserId)}"
                                    th:classappend="${liked ? 'text-primary fw-bold' : 'text-dark'}">
                                üëç Th√≠ch <span th:text="${post.reactions.size()}">0</span>
                            </button>
                        </form>
                        <a href="#" class="text-decoration-none text-dark">
                            üí¨ B√¨nh lu·∫≠n <span th:text="${post.comments.size()}">0</span>
                        </a>
                    </div>

                    <hr>

                    <div class="comments-section">
                        <div th:each="comment : ${post.comments}" class="mb-2 d-flex">
                            <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                <img th:if="${comment.user.avatarUrl != null}"
                                     th:src="@{/view-file/{fileName}(fileName=${comment.user.avatarUrl})}" alt="Avatar">
                                <span th:if="${comment.user.avatarUrl == null}"
                                      th:text="${#strings.substring(comment.user.name, 0, 1)}"></span>
                            </div>
                            <div class="ms-2" style="background-color: #f0f2f5; border-radius: 15px; padding: 8px 12px; flex-grow: 1;">
                                <strong>
                                    <a th:href="@{/profile/{username}(username=${comment.user.username})}"
                                       th:text="${comment.user.name}"
                                       style="text-decoration: none; color: inherit;">T√™n User</a>
                                </strong>
                                <p th:text="${comment.content}" class="mb-0">N·ªôi dung.</p>
                                <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'HH:mm dd/MM/yyyy')}"></small>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3" sec:authorize="isAuthenticated()">
                        <form th:action="@{/posts/{postId}/comment(postId=${post.id})}"
                              th:object="${commentDto}" method="POST" class="d-flex">
                            <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                <img th:if="${currentUser != null && currentUser.avatarUrl != null}"
                                     th:src="@{/view-file/{fileName}(fileName=${currentUser.avatarUrl})}" alt="Avatar">
                                <span th:if="${currentUser == null || currentUser.avatarUrl == null}"
                                      th:text="${currentUser != null ? #strings.substring(currentUser.name, 0, 1) : '?'}"></span>
                            </div>
                            <input type="text" class="form-control" th:field="*{content}"
                                   placeholder="Vi·∫øt b√¨nh lu·∫≠n..." style="border-radius: 20px;"/>
                            <button type="submit" class="btn btn-primary ms-2" style="border-radius: 20px;">G·ª≠i</button>
                        </form>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>
</body>
</html>