<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout.html}">
<head>
    <title th:text="${pageTitle}">Trang ch·ªß</title>
    <style>
        /* CSS cho n√∫t Xem tr∆∞·ªõc */
        .btn-preview {
            border-radius: 20px;
            background-color: #f0f2f5;
            color: #333;
            border: 1px solid #ddd;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 0.9rem;
        }
        .btn-preview:hover {
            background-color: #e4e6eb;
            color: #000;
        }
        .preview-iframe { width: 100%; height: 75vh; border: none; border-radius: 8px; background-color: #f8f9fa; }
        .preview-image { max-width: 100%; max-height: 75vh; display: block; margin: 0 auto; border-radius: 8px; }
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="row justify-content-center">
        <div class="col-lg-3 d-none d-lg-block">
            <div class="card sidebar-left">
                <div class="card-body">
                    <h5 class="card-title">Menu</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><a th:href="@{/profile/edit}" class="text-decoration-none text-dark">‚öôÔ∏è C√†i ƒë·∫∑t t√†i kho·∫£n</a></li>
                        <li class="list-group-item"><a th:href="@{/documents}" class="text-decoration-none text-dark">üìÇ Kho t√†i li·ªáu</a></li>
                        <li class="list-group-item"><a th:href="@{/chat}" class="text-decoration-none text-dark">üí¨ Tin nh·∫Øn</a></li>
                        <li class="list-group-item"><a th:href="@{/friends}" class="text-decoration-none text-dark">üë• L·ªùi m·ªùi k·∫øt b·∫°n</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-8">
            <div class="card mb-4 shadow-sm" style="border-radius: 15px; border: none;">
                <div class="card-body p-3">
                    <form th:action="@{/}" method="GET" class="d-flex align-items-center">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0" style="border-radius: 20px 0 0 20px; border: 1px solid #e0e0e0;">üîç</span>
                            <input type="text" name="keyword" class="form-control border-start-0" placeholder="T√¨m ki·∫øm..." th:value="${keyword}" style="border-radius: 0 20px 20px 0; border: 1px solid #e0e0e0; box-shadow: none;">
                            <button type="submit" class="btn btn-primary ms-2 fw-bold" style="border-radius: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; padding: 8px 20px;">T√¨m</button>
                        </div>
                        <a th:if="${keyword != null && !keyword.isEmpty()}" th:href="@{/}" class="btn btn-light ms-2" style="border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" title="X√≥a t√¨m ki·∫øm">‚úñ</a>
                    </form>
                </div>
            </div>

            <div th:if="${successMessage}" class="alert alert-success" role="alert"><span th:text="${successMessage}"></span></div>
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert"><span th:text="${errorMessage}"></span></div>

            <div class="card mb-3" th:each="post : ${posts}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <a th:href="@{/profile/{username}(username=${post.user.username})}">
                                <div class="post-author-avatar">
                                    <img th:if="${post.user.avatarUrl != null}" th:src="@{/view-file/{fileName}(fileName=${post.user.avatarUrl})}" alt="Avatar">
                                    <span th:if="${post.user.avatarUrl == null}" th:text="${#strings.substring(post.user.name, 0, 1)}">A</span>
                                </div>
                            </a>
                            <div class="ms-2">
                                <a class="fw-bold text-decoration-none text-dark" th:href="@{/profile/{username}(username=${post.user.username})}" th:text="${post.user.name}">Name</a>
                                <div class="text-muted small">
                                    <span th:text="${#temporals.format(post.createdAt, 'HH:mm ''ng√†y'' dd/MM/yyyy')}">Date</span>
                                    <span th:if="${post.isPublic}" title="C√¥ng khai">üåê</span><span th:if="${!post.isPublic}" title="Ri√™ng t∆∞">üîí</span>
                                </div>
                            </div>
                        </div>
                        <div class="dropdown" th:if="${currentUserId == post.user.id}">
                            <button class="btn btn-link text-dark p-0" type="button" data-bs-toggle="dropdown">‚ãÆ</button>
                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                                <li><a class="dropdown-item py-2" th:href="@{/posts/edit/{id}(id=${post.id})}">‚úèÔ∏è S·ª≠a</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="POST" onsubmit="return confirm('X√≥a b√†i vi·∫øt n√†y?');">
                                        <button type="submit" class="dropdown-item py-2 text-danger">üóëÔ∏è X√≥a</button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <p class="card-text" th:if="${post.content}" th:text="${post.content}"></p>

                    <div th:if="${!post.documents.isEmpty()}" class="mt-3">
                        <div class="list-group">
                            <div th:each="doc : ${post.documents}" class="list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded p-3">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h5 class="mb-1 fw-bold" style="font-size: 1.1rem;">üìÑ <span th:text="${doc.title ?: doc.fileName}">Title</span></h5>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn-preview" th:onclick="previewFile([[${doc.storagePath}]], [[${doc.fileName}]], [[${doc.title}]])">üëÅÔ∏è Xem</button>
                                        <a th:href="@{/download/{fileName}(fileName=${doc.storagePath})}" class="btn btn-sm btn-primary ms-1 flex-shrink-0" style="border-radius: 20px; display: flex; align-items: center;">‚¨á T·∫£i</a>
                                    </div>
                                </div>
                                <p class="mb-1" th:if="${doc.description != post.content}" th:text="${doc.description}"></p>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <div class="d-flex gap-3">
                        <form th:action="@{/posts/{postId}/like(postId=${post.id})}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-link text-decoration-none p-0" th:with="liked = ${#lists.contains(post.reactions.![user.id], currentUserId)}" th:classappend="${liked ? 'text-primary fw-bold' : 'text-dark'}">
                                üëç Th√≠ch <span th:text="${post.reactions.size()}">0</span>
                            </button>
                        </form>
                        <a href="#" class="text-decoration-none text-dark">üí¨ B√¨nh lu·∫≠n <span th:text="${post.comments.size()}">0</span></a>
                    </div>
                    <hr>

                    <div class="comments-wrapper">
                        <div th:id="'comments-list-' + ${post.id}">
                            <div th:each="comment, iter : ${post.comments}"
                                 th:id="'comment-' + ${comment.id}"
                                 class="mb-2 d-flex group-comment-item"
                                 th:classappend="${iter.index >= 3} ? 'd-none hidden-comment-' + ${post.id} : ''">

                                <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                    <img th:if="${comment.user.avatarUrl != null}" th:src="@{/view-file/{fileName}(fileName=${comment.user.avatarUrl})}" alt="Avatar">
                                    <span th:if="${comment.user.avatarUrl == null}" th:text="${#strings.substring(comment.user.name, 0, 1)}"></span>
                                </div>
                                <div class="ms-2 position-relative" style="background-color: #f0f2f5; border-radius: 15px; padding: 8px 12px; flex-grow: 1;">
                                    <strong><a th:href="@{/profile/{username}(username=${comment.user.username})}" th:text="${comment.user.name}" style="text-decoration: none; color: inherit;">Name</a></strong>
                                    <p th:text="${comment.content}" class="mb-0">N·ªôi dung</p>
                                    <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'HH:mm dd/MM/yyyy')}"></small>
                                    <button th:if="${currentUser != null && (comment.user.id == currentUser.id || post.user.id == currentUser.id)}" class="btn btn-sm text-danger position-absolute top-0 end-0 p-1 delete-comment-btn" th:attr="data-id=${comment.id}" style="font-size: 12px; margin-right: 5px;">‚úñ</button>
                                </div>
                            </div>
                        </div>

                        <div th:if="${post.comments.size() > 3}" class="text-center mt-2 view-more-container">
                            <a href="javascript:void(0)" class="text-decoration-none small fw-bold text-secondary" th:id="'btn-more-' + ${post.id}" th:onclick="'toggleComments(' + ${post.id} + ', true)'">‚ñº Xem th√™m c√°c b√¨nh lu·∫≠n c≈© h∆°n... (<span th:text="${post.comments.size() - 3}"></span>)</a>
                            <a href="javascript:void(0)" class="text-decoration-none small fw-bold text-secondary" th:id="'btn-less-' + ${post.id}" style="display: none;" th:onclick="'toggleComments(' + ${post.id} + ', false)'">‚ñ≤ Thu g·ªçn b√¨nh lu·∫≠n</a>
                        </div>
                    </div>
                    <div class="mt-3" sec:authorize="isAuthenticated()">
                        <form th:action="@{/posts/{postId}/comment(postId=${post.id})}" th:object="${commentDto}" method="POST" class="d-flex">
                            <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                <img th:if="${currentUser != null && currentUser.avatarUrl != null}" th:src="@{/view-file/{fileName}(fileName=${currentUser.avatarUrl})}" alt="Avatar">
                                <span th:if="${currentUser == null || currentUser.avatarUrl == null}" th:text="${currentUser != null ? #strings.substring(currentUser.name, 0, 1) : '?'}"></span>
                            </div>
                            <input type="text" class="form-control" th:field="*{content}" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." style="border-radius: 20px;"/>
                            <button type="submit" class="btn btn-primary ms-2" style="border-radius: 20px;">G·ª≠i</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-4">
            <div class="card sidebar-right">
                <div class="card-body">
                    <h5 class="card-title">Li√™n h·ªá</h5>
                    <div class="user-list-container" th:if="${contacts != null}">
                        <div th:each="contact : ${contacts}" th:if="${contact.type == T(com.studyhub.StudyHub.entity.ChatRoom.RoomType).ONE_TO_ONE}">
                            <a th:href="@{/chat(withUser=${contact.oneToOnePartnerId})}" class="user-list-item-link">
                                <div class="user-list-item">
                                    <div class="user-avatar-container">
                                        <img th:if="${contact.oneToOnePartnerAvatarUrl}" th:src="@{/view-file/{f}(f=${contact.oneToOnePartnerAvatarUrl})}" class="user-avatar-image">
                                        <div th:unless="${contact.oneToOnePartnerAvatarUrl}" class="user-avatar-default"><span th:text="${#strings.substring(contact.oneToOnePartnerName, 0, 1)}"></span></div>
                                        <span class="status-dot" th:classappend="${onlineUsers.contains(contact.oneToOnePartnerUsername) ? 'online' : ''}"></span>
                                    </div>
                                    <div class="user-info"><span class="user-name" th:text="${contact.oneToOnePartnerName}">Name</span></div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="modals">
    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                <div class="modal-header border-0 bg-light py-2">
                    <h5 class="modal-title fw-bold text-primary" id="previewTitle">üìÑ Xem t√†i li·ªáu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 bg-light text-center d-flex align-items-center justify-content-center" style="min-height: 400px;">
                    <div id="previewContent" class="w-100 h-100"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteCommentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content" style="border-radius: 20px; border: none;">
                <div class="modal-body text-center pt-4">
                    <div style="width: 60px; height: 60px; background-color: #fee2e2; color: #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; margin: 0 auto 15px auto;">üóëÔ∏è</div>
                    <h5 class="fw-bold">X√≥a b√¨nh lu·∫≠n?</h5>
                    <p class="text-muted small">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                </div>
                <div class="modal-footer border-0 justify-content-center pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete-comment">X√≥a</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="scripts">
    function previewFile(storagePath, fileName, title) {
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        document.getElementById('previewTitle').textContent = title || fileName;
        const ext = fileName.split('.').pop().toLowerCase();
        const url = '/view-file/' + storagePath;
        let html = '';
        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) html = `<img src="${url}" class="preview-image">`;
        else if (ext === 'pdf') html = `<iframe src="${url}" class="preview-iframe"></iframe>`;
        else html = `<div class="p-5 text-center">Kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc. <a href="/download/${storagePath}" class="btn btn-primary">T·∫£i xu·ªëng</a></div>`;
        document.getElementById('previewContent').innerHTML = html;
        modal.show();
    }

    let stompClientFeed = null;
    function connectFeed() {
        const socket = new SockJS('/ws');
        stompClientFeed = Stomp.over(socket);
        stompClientFeed.debug = null;
        stompClientFeed.connect({}, function (frame) {
            stompClientFeed.subscribe('/topic/comments', function (payload) {
                const data = JSON.parse(payload.body);
                if (data.type === 'DELETE_COMMENT') handleDeleteCommentUI(data.commentId);
                else appendNewComment(data);
            });
        });
    }

    function handleDeleteCommentUI(id) {
        const el = document.getElementById('comment-' + id);
        if (el) { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }
    }

    function deleteComment(id) {
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        fetch('/api/comments/' + id + '/delete', { method: 'POST', headers: { [header]: token } });
    }

    // === S·ª¨A H√ÄM N√ÄY ƒê·ªÇ CH√àN L√äN ƒê·∫¶U ===
    function appendNewComment(cmt) {
        if (!cmt.content || !cmt.postId) return;

        // T√¨m ƒë√∫ng div danh s√°ch comment (comments-list-{id})
        const container = document.getElementById('comments-list-' + cmt.postId);

        if (container) {
            const initial = cmt.senderName.charAt(0).toUpperCase();
            const avatarHtml = cmt.senderAvatar ? `<img src="/view-file/${cmt.senderAvatar}" alt="Avatar">` : `<span>${initial}</span>`;

            const html = `
            <div id="comment-${cmt.id}" class="mb-2 d-flex group-comment-item animate-fade-in">
                <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">${avatarHtml}</div>
                <div class="ms-2 position-relative" style="background-color: #f0f2f5; border-radius: 15px; padding: 8px 12px; flex-grow: 1;">
                    <strong><a href="/profile/${cmt.senderUsername}" style="text-decoration: none; color: inherit;">${cmt.senderName}</a></strong>
                    <p class="mb-0">${cmt.content}</p>
                    <small class="text-muted">V·ª´a xong</small>
                    <button class="btn btn-sm text-danger position-absolute top-0 end-0 p-1 delete-comment-btn" data-id="${cmt.id}" style="font-size: 12px; margin-right: 5px;">‚úñ</button>
                </div>
            </div>`;

            // S·ª¨A: D√πng afterbegin ƒë·ªÉ ch√®n l√™n ƒê·∫¶U danh s√°ch (tr√™n comment c≈©)
            container.insertAdjacentHTML('afterbegin', html);
        }
    }

    let commentIdToDelete = null;
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.delete-comment-btn');
        if (btn) {
            e.preventDefault();
            commentIdToDelete = btn.getAttribute('data-id');
            new bootstrap.Modal(document.getElementById('deleteCommentModal')).show();
        }
    });

    document.getElementById('btn-confirm-delete-comment').addEventListener('click', function() {
        if (commentIdToDelete) {
            deleteComment(commentIdToDelete);
            bootstrap.Modal.getInstance(document.getElementById('deleteCommentModal')).hide();
            commentIdToDelete = null;
        }
    });

    function toggleComments(postId, showMore) {
        const hidden = document.querySelectorAll('.hidden-comment-' + postId);
        const btnMore = document.getElementById('btn-more-' + postId);
        const btnLess = document.getElementById('btn-less-' + postId);

        hidden.forEach(el => {
            if (showMore) { el.classList.remove('d-none'); el.classList.add('animate-fade-in'); }
            else { el.classList.add('d-none'); el.classList.remove('animate-fade-in'); }
        });

        if (showMore) { btnMore.style.display = 'none'; btnLess.style.display = 'inline-block'; }
        else { btnMore.style.display = 'inline-block'; btnLess.style.display = 'none'; }
    }

    const style = document.createElement('style');
    style.innerHTML = `.animate-fade-in { animation: fadeIn 0.5s ease-in; } @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }`;
    document.head.appendChild(style);

    document.addEventListener('DOMContentLoaded', connectFeed);
</script>

</body>
</html>