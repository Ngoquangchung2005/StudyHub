<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout.html}">
<head>
    <title th:text="${pageTitle}">Trang ch·ªß</title>
    <style>
        /* CSS cho n√∫t Xem tr∆∞·ªõc */
        .btn-preview {
            border-radius: 20px;
            background-color: #f0f2f5;
            color: #333;
            border: 1px solid #ddd;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 0.9rem;
        }
        .btn-preview:hover {
            background-color: #e4e6eb;
            color: #000;
        }

        /* Modal preview full height */
        .preview-iframe {
            width: 100%;
            height: 75vh;
            border: none;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .preview-image {
            max-width: 100%;
            max-height: 75vh;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="row justify-content-center">

        <div class="col-lg-3 d-none d-lg-block">
            <div class="card sidebar-left">
                <div class="card-body">
                    <h5 class="card-title">Menu</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <a th:href="@{/profile/edit}" class="text-decoration-none text-dark">‚öôÔ∏è C√†i ƒë·∫∑t t√†i kho·∫£n</a>
                        </li>
                        <li class="list-group-item">
                            <a th:href="@{/documents}" class="text-decoration-none text-dark">üìÇ Kho t√†i li·ªáu</a>
                        </li>
                        <li class="list-group-item">
                            <a th:href="@{/chat}" class="text-decoration-none text-dark">üí¨ Tin nh·∫Øn</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-6 col-md-8">

            <div class="card mb-4 shadow-sm" style="border-radius: 15px; border: none;">
                <div class="card-body p-3">
                    <form th:action="@{/}" method="GET" class="d-flex align-items-center">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0" style="border-radius: 20px 0 0 20px; border: 1px solid #e0e0e0;">
                                üîç
                            </span>
                            <input type="text" name="keyword"
                                   class="form-control border-start-0"
                                   placeholder="T√¨m ki·∫øm t√†i li·ªáu, b√†i vi·∫øt, tags..."
                                   th:value="${keyword}"
                                   style="border-radius: 0 20px 20px 0; border: 1px solid #e0e0e0; box-shadow: none;">
                            <button type="submit" class="btn btn-primary ms-2 fw-bold"
                                    style="border-radius: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; padding: 8px 20px;">
                                T√¨m
                            </button>
                        </div>
                        <a th:if="${keyword != null && !keyword.isEmpty()}"
                           th:href="@{/}"
                           class="btn btn-light ms-2"
                           style="border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
                           title="X√≥a t√¨m ki·∫øm">
                            ‚úñ
                        </a>
                    </form>
                </div>
            </div>

            <div th:if="${successMessage}" class="alert alert-success" role="alert">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                <span th:text="${errorMessage}"></span>
            </div>

            <h2 class="h4 mb-3" th:if="${keyword == null}">B√†i ƒëƒÉng g·∫ßn ƒë√¢y</h2>
            <h2 class="h4 mb-3" th:if="${keyword != null}">K·∫øt qu·∫£ t√¨m ki·∫øm cho: "<span th:text="${keyword}"></span>"</h2>

            <div th:if="${posts == null || posts.isEmpty()}" class="alert alert-info">
                <span th:if="${keyword == null}">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o.</span>
                <span th:if="${keyword != null}">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o ph√π h·ª£p.</span>
            </div>

            <div class="card mb-3" th:each="post : ${posts}">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <a th:href="@{/profile/{username}(username=${post.user.username})}">
                                <div class="post-author-avatar">
                                    <img th:if="${post.user.avatarUrl != null}"
                                         th:src="@{/view-file/{fileName}(fileName=${post.user.avatarUrl})}"
                                         alt="Avatar">
                                    <span th:if="${post.user.avatarUrl == null}"
                                          th:text="${#strings.substring(post.user.name, 0, 1)}">
                                        A
                                    </span>
                                </div>
                            </a>
                            <div class="ms-2">
                                <a class="fw-bold text-decoration-none text-dark"
                                   th:href="@{/profile/{username}(username=${post.user.username})}"
                                   th:text="${post.user.name}">T√™n T√°c Gi·∫£</a>
                                <div class="text-muted small">
                                    <span th:text="${#temporals.format(post.createdAt, 'HH:mm ''ng√†y'' dd/MM/yyyy')}">
                                        Ng√†y ƒëƒÉng
                                    </span>
                                    <span th:if="${post.isPublic}" title="C√¥ng khai">üåê</span>
                                    <span th:if="${!post.isPublic}" title="Ri√™ng t∆∞">üîí</span>
                                </div>
                            </div>
                        </div>

                        <div class="dropdown" th:if="${currentUserId == post.user.id}">
                            <button class="btn btn-link text-dark p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="text-decoration: none; font-size: 20px;">
                                ‚ãÆ
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                                <li>
                                    <a class="dropdown-item py-2" th:href="@{/posts/edit/{id}(id=${post.id})}">
                                        ‚úèÔ∏è Ch·ªânh s·ª≠a b√†i vi·∫øt
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="POST"
                                          onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.');">
                                        <button type="submit" class="dropdown-item py-2 text-danger">
                                            üóëÔ∏è X√≥a b√†i vi·∫øt
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <p class="card-text" th:if="${post.content != null && !post.content.isEmpty()}"
                       th:text="${post.content}">N·ªôi dung b√†i ƒëƒÉng...</p>

                    <div th:if="${post.documents != null && !post.documents.isEmpty()}" class="mt-3">
                        <div class="list-group">
                            <div th:each="doc : ${post.documents}"
                                 class="list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded p-3">

                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h5 class="mb-1 fw-bold" style="font-size: 1.1rem;">
                                        üìÑ
                                        <span th:text="${doc.title != null && !doc.title.isEmpty() ? doc.title : doc.fileName}">
                                            Ti√™u ƒë·ªÅ t√†i li·ªáu
                                        </span>
                                    </h5>

                                    <div class="d-flex gap-2">
                                        <button type="button"
                                                class="btn-preview"
                                                th:onclick="previewFile([[${doc.storagePath}]], [[${doc.fileName}]], [[${doc.title}]])"
                                                title="Xem tr∆∞·ªõc">
                                            üëÅÔ∏è Xem
                                        </button>

                                        <a th:href="@{/download/{fileName}(fileName=${doc.storagePath})}"
                                           class="btn btn-sm btn-primary ms-1 flex-shrink-0"
                                           style="border-radius: 20px; display: flex; align-items: center;">
                                            ‚¨á T·∫£i xu·ªëng
                                        </a>
                                    </div>
                                </div>

                                <p class="mb-1"
                                   th:if="${doc.description != null && !doc.description.isEmpty() && doc.description != post.content}"
                                   th:text="${doc.description}">
                                    M√¥ t·∫£ t√†i li·ªáu...
                                </p>

                                <small class="text-muted d-block mt-2">
                                    <span th:if="${doc.category != null}"
                                          class="badge bg-secondary me-2"
                                          th:text="${doc.category.name}">Category</span>
                                    <span th:text="${doc.fileName} + ' (' + (${doc.fileSize < 1024*1024 ? #numbers.formatDecimal(doc.fileSize / 1024.0, 1, 'COMMA', 1, 'POINT') + ' KB' : #numbers.formatDecimal(doc.fileSize / 1024.0 / 1024.0, 1, 'COMMA', 1, 'POINT') + ' MB'}) + ')'">
                                        size
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex gap-3">
                        <form th:action="@{/posts/{postId}/like(postId=${post.id})}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-link text-decoration-none p-0"
                                    th:with="liked = ${#lists.contains(post.reactions.![user.id], currentUserId)}"
                                    th:classappend="${liked ? 'text-primary fw-bold' : 'text-dark'}">
                                üëç Th√≠ch
                                <span th:text="${post.reactions.size()}">0</span>
                            </button>
                        </form>
                        <a href="#" class="text-decoration-none text-dark">
                            üí¨ B√¨nh lu·∫≠n
                            <span th:text="${post.comments.size()}">0</span>
                        </a>
                    </div>

                    <hr>

                    <div class="comments-section" th:id="'comments-area-' + ${post.id}">

                        <div th:each="comment : ${post.comments}" class="mb-2 d-flex">
                            <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                <img th:if="${comment.user.avatarUrl != null}"
                                     th:src="@{/view-file/{fileName}(fileName=${comment.user.avatarUrl})}"
                                     alt="Avatar">
                                <span th:if="${comment.user.avatarUrl == null}"
                                      th:text="${#strings.substring(comment.user.name, 0, 1)}">
                                </span>
                            </div>
                            <div class="ms-2" style="background-color: #f0f2f5; border-radius: 15px; padding: 8px 12px; flex-grow: 1;">
                                <strong>
                                    <a th:href="@{/profile/{username}(username=${comment.user.username})}"
                                       th:text="${comment.user.name}"
                                       style="text-decoration: none; color: inherit;">
                                        T√™n User
                                    </a>
                                </strong>
                                <p th:text="${comment.content}" class="mb-0">N·ªôi dung b√¨nh lu·∫≠n.</p>
                                <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'HH:mm dd/MM/yyyy')}"></small>
                            </div>
                        </div>

                    </div>

                    <div class="mt-3" sec:authorize="isAuthenticated()">
                        <form th:action="@{/posts/{postId}/comment(postId=${post.id})}"
                              th:object="${commentDto}" method="POST" class="d-flex">
                            <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                <img th:if="${currentUser != null && currentUser.avatarUrl != null}"
                                     th:src="@{/view-file/{fileName}(fileName=${currentUser.avatarUrl})}"
                                     alt="Avatar">
                                <span th:if="${currentUser == null || currentUser.avatarUrl == null}"
                                      th:text="${currentUser != null ? #strings.substring(currentUser.name, 0, 1) : '?'}">
                                </span>
                            </div>
                            <input type="text" class="form-control" th:field="*{content}"
                                   placeholder="Vi·∫øt b√¨nh lu·∫≠n..." style="border-radius: 20px;"/>
                            <button type="submit" class="btn btn-primary ms-2" style="border-radius: 20px;">G·ª≠i</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-4">
            <div class="card sidebar-right">
                <div class="card-body">
                    <h5 class="card-title">Li√™n h·ªá</h5>

                    <div class="user-list-container" th:if="${contacts != null && !contacts.isEmpty()}">
                        <div th:each="contact : ${contacts}"
                             th:if="${contact.type == T(com.studyhub.StudyHub.entity.ChatRoom.RoomType).ONE_TO_ONE}">
                            <a th:href="@{/chat(withUser=${contact.oneToOnePartnerId})}" class="user-list-item-link">
                                <div th:with="isOnline = ${onlineUsers.contains(contact.oneToOnePartnerUsername)}"
                                     class="user-list-item">
                                    <div class="user-avatar-container">
                                        <img th:if="${contact.oneToOnePartnerAvatarUrl != null}"
                                             th:src="@{/view-file/{fileName}(fileName=${contact.oneToOnePartnerAvatarUrl})}"
                                             class="user-avatar-image">
                                        <div th:if="${contact.oneToOnePartnerAvatarUrl == null}"
                                             class="user-avatar-default">
                                            <span th:text="${#strings.substring(contact.oneToOnePartnerName, 0, 1)}"></span>
                                        </div>
                                        <span class="status-dot" th:classappend="${isOnline ? 'online' : ''}"></span>
                                    </div>
                                    <div class="user-info">
                                        <span class="user-name" th:text="${contact.oneToOnePartnerName}">T√™n</span>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <p th:if="${contacts == null || contacts.isEmpty()}" class="text-muted small">
                        B·∫°n ch∆∞a nh·∫Øn tin v·ªõi ai.
                    </p>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                <div class="modal-header border-0 bg-light py-2">
                    <h5 class="modal-title fw-bold text-primary" id="previewTitle">üìÑ Xem t√†i li·ªáu</h5>
                    <div class="ms-auto d-flex gap-2">
                        <a href="#" id="previewDownloadBtn" class="btn btn-primary btn-sm rounded-pill">‚¨á T·∫£i xu·ªëng</a>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body p-0 bg-light text-center d-flex align-items-center justify-content-center" style="min-height: 400px;">
                    <div id="previewContent" class="w-100 h-100">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function previewFile(storagePath, fileName, title) {
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            const contentDiv = document.getElementById('previewContent');
            const titleEl = document.getElementById('previewTitle');
            const downloadBtn = document.getElementById('previewDownloadBtn');

            // Set th√¥ng tin c∆° b·∫£n
            titleEl.textContent = title || fileName;
            downloadBtn.href = '/download/' + storagePath;

            // X√°c ƒë·ªãnh lo·∫°i file
            const ext = fileName.split('.').pop().toLowerCase();
            const fileUrl = '/view-file/' + storagePath;

            let html = '';

            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) {
                html = `<img src="${fileUrl}" class="preview-image" alt="Preview">`;
            } else if (ext === 'pdf') {
                html = `<iframe src="${fileUrl}" class="preview-iframe"></iframe>`;
            } else if (ext === 'txt') {
                html = `<iframe src="${fileUrl}" class="preview-iframe" style="background: white;"></iframe>`;
            } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
                html = `<video controls class="preview-image" style="background:black;"><source src="${fileUrl}" type="video/${ext}">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video n√†y.</video>`;
            } else {
                html = `
                    <div class="text-center p-5">
                        <div style="font-size: 60px; margin-bottom: 20px;">üìù</div>
                        <h4>Kh√¥ng h·ªó tr·ª£ xem tr∆∞·ªõc ƒë·ªãnh d·∫°ng n√†y</h4>
                        <p class="text-muted">ƒê√¢y l√† file <b>.${ext.toUpperCase()}</b>. Vui l√≤ng t·∫£i xu·ªëng ƒë·ªÉ xem n·ªôi dung.</p>
                        <a href="/download/${storagePath}" class="btn btn-lg btn-primary mt-2 rounded-pill">
                            ‚¨á T·∫£i xu·ªëng m√°y
                        </a>
                    </div>
                `;
            }

            contentDiv.innerHTML = html;
            modal.show();
        }

            // K·∫øt n·ªëi WebSocket ri√™ng cho Feed (ƒë·ªÉ nh·∫≠n comment realtime)
            let stompClientFeed = null;

            function connectFeed() {
            const socket = new SockJS('/ws');
            stompClientFeed = Stomp.over(socket);
            stompClientFeed.debug = null; // T·∫Øt log console cho g·ªçn

            stompClientFeed.connect({}, function (frame) {
            console.log('Connected Feed WS');

            // ƒêƒÉng k√Ω l·∫Øng nghe topic comments
            stompClientFeed.subscribe('/topic/comments', function (payload) {
            const cmt = JSON.parse(payload.body);
            appendNewComment(cmt);
        });

        }, function (error) {
            console.log('Feed WS Error: ' + error);
        });
        }

            // H√†m v·∫Ω Comment m·ªõi l√™n giao di·ªán
            function appendNewComment(cmt) {
            // T√¨m v√πng ch·ª©a comment c·ªßa b√†i vi·∫øt t∆∞∆°ng ·ª©ng b·∫±ng ID
            const commentArea = document.getElementById('comments-area-' + cmt.postId);

            // N·∫øu t√¨m th·∫•y (t·ª©c l√† b√†i vi·∫øt ƒë√≥ ƒëang hi·ªÉn th·ªã tr√™n m√†n h√¨nh ng∆∞·ªùi d√πng)
            if (commentArea) {
            // X·ª≠ l√Ω Avatar
            const initial = cmt.senderName.charAt(0).toUpperCase();
            let avatarHtml = '';

            if (cmt.senderAvatar) {
            avatarHtml = `<img src="/view-file/${cmt.senderAvatar}" alt="Avatar">`;
        } else {
            avatarHtml = `<span>${initial}</span>`;
        }

            // T·∫°o HTML cho comment m·ªõi (Copy c·∫•u tr√∫c t·ª´ Thymeleaf ph√≠a tr√™n)
            const html = `
                <div class="mb-2 d-flex animate-fade-in">
                    <div class="post-author-avatar me-2" style="width: 32px; height: 32px; font-size: 0.9rem;">
                        ${avatarHtml}
                    </div>
                    <div class="ms-2" style="background-color: #f0f2f5; border-radius: 15px; padding: 8px 12px; flex-grow: 1;">
                        <strong>
                            <a href="/profile/${cmt.senderUsername}" style="text-decoration: none; color: inherit;">
                                ${cmt.senderName}
                            </a>
                        </strong>
                        <p class="mb-0">${cmt.content}</p>
                        <small class="text-muted">${cmt.createdAt}</small>
                    </div>
                </div>
            `;

            // Ch√®n v√†o cu·ªëi danh s√°ch
            commentArea.insertAdjacentHTML('beforeend', html);
        }
        }

            // Hi·ªáu ·ª©ng xu·∫•t hi·ªán nh·∫π nh√†ng
            const style = document.createElement('style');
            style.innerHTML = `
            .animate-fade-in { animation: fadeIn 0.5s ease-in; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
            `;
            document.head.appendChild(style);

            // K√≠ch ho·∫°t k·∫øt n·ªëi khi trang load
            document.addEventListener('DOMContentLoaded', connectFeed);

    </script>

</div>

</body>
</html>