<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<head>
    <title>ÄÄƒng táº£i tÃ i liá»‡u</title>
    <link th:href="@{/css/upload.css}" rel="stylesheet" />
</head>
<body>

<div layout:fragment="content">

    <div class="upload-container">

        <div class="upload-header">
            <h1>ğŸ“¤ ÄÄƒng táº£i tÃ i liá»‡u</h1>
            <p>Chia sáº» kiáº¿n thá»©c cá»§a báº¡n vá»›i cá»™ng Ä‘á»“ng há»c táº­p</p>
        </div>

        <form th:action="@{/posts/create}"
              th:object="${postDto}"
              method="POST"
              enctype="multipart/form-data"
              id="uploadForm">

            <div class="file-upload-zone" id="dropZone">
                <div class="file-icon-big">ğŸ“</div>
                <h4>KÃ©o tháº£ file vÃ o Ä‘Ã¢y</h4>
                <p>hoáº·c <strong>báº¥m Ä‘á»ƒ chá»n file tá»« mÃ¡y tÃ­nh</strong></p>
                <small style="color: #999;">Há»— trá»£: PDF, Word, Excel, PowerPoint, TXT (Max 50MB)</small>
                <input type="file"
                       id="fileInput"
                       th:field="*{files}"
                       accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt"
                       style="display: none;"
                       multiple
                       required>
            </div>

            <div class="file-selected" id="fileSelected">
                <div class="file-preview-icon" id="fileIcon">ğŸ“„</div>
                <div class="file-info">
                    <h5 id="fileName">file.pdf</h5>
                    <small id="fileSize">0 MB</small>
                </div>
                <button type="button" class="btn btn-danger" onclick="clearFile()" style="margin-left: auto;">
                    âŒ XÃ³a
                </button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ“ TiÃªu Ä‘á» tÃ i liá»‡u <span>*</span></label>
                    <input type="text"
                           class="form-control"
                           th:field="*{title}"
                           placeholder="VD: GiÃ¡o trÃ¬nh Láº­p trÃ¬nh Java cÆ¡ báº£n"
                           required>
                </div>
                <div class="form-group">
                    <label>ğŸ·ï¸ Tags (tá»« khÃ³a)</label>
                    <input type="text"
                           class="form-control"
                           th:field="*{tags}"
                           placeholder="VD: java, spring, backend">
                    <div class="tag-hint">
                        ğŸ’¡ PhÃ¢n cÃ¡ch báº±ng dáº¥u pháº©y
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ“„ MÃ´ táº£ chi tiáº¿t</label>
                <textarea class="form-control"
                          th:field="*{description}"
                          placeholder="MÃ´ táº£ ná»™i dung, Ä‘á»‘i tÆ°á»£ng phÃ¹ há»£p, kiáº¿n thá»©c cáº§n cÃ³..."></textarea>
            </div>

            <div class="form-group">
                <label>ğŸ“‚ Chá»n danh má»¥c <span>*</span></label>
                <div class="category-grid">
                    <div class="category-item" th:each="cat : ${categories}">
                        <input type="radio"
                               th:id="${'cat_' + cat.id}"
                               name="categoryId"
                               th:value="${cat.id}"
                               required>
                        <label th:for="${'cat_' + cat.id}" class="category-label">
                            <span class="category-icon" th:text="${cat.icon}">ğŸ“š</span>
                            <span class="category-name" th:text="${cat.name}">Category</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ”’ Quyá»n riÃªng tÆ°</label>

                <label class="privacy-option">
                    <input type="radio" name="isPublic" value="true" checked>
                    <div class="privacy-label">
                        <strong>ğŸŒ CÃ´ng khai</strong><br>
                        <small>Má»i ngÆ°á»i Ä‘á»u cÃ³ thá»ƒ xem vÃ  táº£i xuá»‘ng</small>
                    </div>
                </label>

                <label class="privacy-option">
                    <input type="radio" name="isPublic" value="false">
                    <div class="privacy-label">
                        <strong>ğŸ”’ RiÃªng tÆ°</strong><br>
                        <small>Chá»‰ mÃ¬nh tÃ´i cÃ³ thá»ƒ xem</small>
                    </div>
                </label>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn">
                ğŸš€ ÄÄƒng táº£i ngay
            </button>

        </form>

    </div>

</div>
<script layout:fragment="scripts">
    { // <--- Báº®T Äáº¦U BLOCK SCOPE (GiÃºp trÃ¡nh trÃ¹ng tÃªn biáº¿n vá»›i chatjs)

        // === 1. KHAI BÃO BIáº¾N ===
        const uploadDropZone = document.getElementById('dropZone');
        const uploadFileInput = document.getElementById('fileInput');
        const uploadFileSelected = document.getElementById('fileSelected');
        const uploadFileName = document.getElementById('fileName');
        const uploadFileSize = document.getElementById('fileSize');
        const uploadFileIcon = document.getElementById('fileIcon');
        const descInput = document.querySelector('textarea[name="description"]');
        const contentInput = document.getElementById('hiddenContent');

        // === 2. Xá»¬ LÃ Sá»° KIá»†N CHá»ŒN FILE ===
        if (uploadDropZone) {
            uploadDropZone.addEventListener('click', () => uploadFileInput.click());

            uploadDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDropZone.classList.add('dragover');
            });

            uploadDropZone.addEventListener('dragleave', () => {
                uploadDropZone.classList.remove('dragover');
            });

            uploadDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    uploadFileInput.files = e.dataTransfer.files;
                    handleFiles();
                }
            });
        }

        if (uploadFileInput) {
            uploadFileInput.addEventListener('change', handleFiles);
        }

        function handleFiles() {
            const files = uploadFileInput.files;
            if (files.length > 0) {
                const file = files[0];
                if (uploadFileName) uploadFileName.textContent = file.name;
                if (uploadFileSize) uploadFileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';

                // Icon Ä‘Æ¡n giáº£n
                if (uploadFileIcon) {
                    if (file.type.includes('pdf')) uploadFileIcon.textContent = 'ğŸ“„';
                    else if (file.type.includes('word')) uploadFileIcon.textContent = 'ğŸ“';
                    else uploadFileIcon.textContent = 'ğŸ“';
                }

                if (uploadFileSelected) uploadFileSelected.classList.add('show');
                if (uploadDropZone) uploadDropZone.style.display = 'none';

                // Tá»± Ä‘á»™ng Ä‘iá»n tiÃªu Ä‘á» náº¿u trá»‘ng
                const titleInput = document.querySelector('input[name="title"]');
                if (titleInput && !titleInput.value) {
                    titleInput.value = file.name.replace(/\.[^/.]+$/, "");
                }
            }
        }

        // HÃ m global Ä‘á»ƒ nÃºt XÃ³a gá»i Ä‘Æ°á»£c (gÃ¡n vÃ o window)
        window.clearFile = function() {
            if (uploadFileInput) uploadFileInput.value = '';
            if (uploadFileSelected) uploadFileSelected.classList.remove('show');
            if (uploadDropZone) uploadDropZone.style.display = 'block';
        };

        // === 3. Xá»¬ LÃ SUBMIT FORM ===
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                // 3.1. Validate TiÃªu Ä‘á»
                const titleInput = document.querySelector('input[name="title"]');
                if (titleInput && !titleInput.value.trim()) {
                    e.preventDefault();
                    alert("Vui lÃ²ng nháº­p tiÃªu Ä‘á» tÃ i liá»‡u!");
                    titleInput.focus();
                    return;
                }

                // 3.2. Validate File
                if (uploadFileInput && uploadFileInput.files.length === 0) {
                    e.preventDefault();
                    alert("Vui lÃ²ng chá»n file Ä‘á»ƒ táº£i lÃªn!");
                    return;
                }

                // 3.3. Validate Danh má»¥c
                const categoryInput = document.querySelector('input[name="categoryId"]:checked');
                if (!categoryInput) {
                    e.preventDefault();
                    alert("Vui lÃ²ng chá»n danh má»¥c!");
                    return;
                }

                // 3.4. Sync Description
                if(descInput && contentInput) {
                    contentInput.value = descInput.value;
                }

                // 3.5. Disable nÃºt submit
                const btn = document.getElementById('submitBtn');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = 'â³ Äang táº£i lÃªn...';
                }
            });
        }

    } // <--- Káº¾T THÃšC BLOCK SCOPE
</script>

</body>
</html>